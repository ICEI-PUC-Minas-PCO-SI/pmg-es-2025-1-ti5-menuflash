<!--Website: wwww.codingdung.com-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodingDung | Profile Template</title>
    <link rel="stylesheet" href="css/perfil.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container light-style flex-grow-1 container-p-y py-5">
        <h1 class="font-weight-bold py-3 mb-4">
            Informações do perfil
        </h1>
        <div class="card overflow-hidden">
            <div class="row no-gutters row-bordered row-border-light">
                <div class="col-md-3 pt-0">
                    <div class="list-group list-group-flush account-settings-links">
                        <a class="list-group-item list-group-item-action active" data-toggle="list"
                            href="#account-general">Informações Pessoais</a>

                        <a class="list-group-item list-group-item-action" data-toggle="list"
                            href="#account-change-password">Trocar Senha</a>

                        <a class="list-group-item list-group-item-action" data-toggle="list"
                            href="#account-info">Favoritos</a>

                        <a class="list-group-item list-group-item-action" data-toggle="list"
                            href="#account-social-links">Histórico de Pedidos</a>

                    </div>
                </div>
                <div class="col-md-9">
                    <div class="tab-content">
                        <div class="tab-pane fade active show" id="account-general">
                            <hr class="border-light m-0">
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Nome</label>
                                    <input type="text" id="userName" class="form-control" value="">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">E-mail</label>
                                    <input type="text" id="userEmail" class="form-control mb-1" value="">
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="account-change-password">
                            <div class="card-body pb-2">
                                <div class="form-group">
                                    <label class="form-label">Senha atual</label>
                                    <input id="inputSenha" type="password" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Nova Senha</label>
                                    <input id="inputNovaSenha1" type="password" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Repita a nova senha</label>
                                    <input id="inputNovaSenha2" type="password" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="account-info">
                            <div class="card-body pb-2">
                                <div class="form-group">
                                    <label class="form-label">Bio</label>
                                    <textarea class="form-control"
                                        rows="5">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris nunc arcu, dignissim sit amet sollicitudin iaculis, vehicula id urna. Sed luctus urna nunc. Donec fermentum, magna sit amet rutrum pretium, turpis dolor molestie diam, ut lacinia diam risus eleifend sapien. Curabitur ac nibh nulla. Maecenas nec augue placerat, viverra tellus non, pulvinar risus.</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Birthday</label>
                                    <input type="text" class="form-control" value="May 3, 1995">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Country</label>
                                    <select class="custom-select">
                                        <option>USA</option>
                                        <option selected>Canada</option>
                                        <option>UK</option>
                                        <option>Germany</option>
                                        <option>France</option>
                                    </select>
                                </div>
                            </div>
                            <hr class="border-light m-0">
                            <div class="card-body pb-2">
                                <h6 class="mb-4">Contacts</h6>
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="text" class="form-control" value="+0 (123) 456 7891">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Website</label>
                                    <input type="text" class="form-control" value>
                                </div>
                            </div>
                        </div>

                        <!-- Histórico de Pedidos -->
                        <div class="tab-pane fade" id="account-social-links" style="min-height: 30rem;">
                            <div class="card-body pb-2">
                                <div id="divHistorico">
                                    <div id="insereHistorico" class=""></div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="action-buttons-wrapper" class="text-right mt-3">
            <button id="btnSaveChanges" type="button" class="btn btn-primary">Salvar Mudanças</button>&nbsp;
            <button id="btnCancel" type="button" class="btn btn-default">Cancelar</button>
        </div>
    </div>
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">

    </script>

    <script src="js/perfil.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const usuarioJSON = sessionStorage.getItem("usuarioLogado");
            if (!usuarioJSON) return window.location.href = "login.html";
            window.usuario = JSON.parse(usuarioJSON);

            document.getElementById("userName").value = usuario.nome;
            document.getElementById("userEmail").value = usuario.email;

            const inputSenha = document.getElementById("inputSenha");
            const inputNova1 = document.getElementById("inputNovaSenha1");
            const inputNova2 = document.getElementById("inputNovaSenha2");
            [inputSenha, inputNova1, inputNova2].forEach(i => i.value = "");
            inputNova1.disabled = inputNova2.disabled = true;

            inputSenha.addEventListener("input", () => {
                const ok = inputSenha.value === usuario.senha;
                inputNova1.disabled = inputNova2.disabled = !ok;
            });
        });

        document.getElementById("btnSaveChanges").addEventListener("click", () => {
            const novoNome = document.getElementById("userName").value.trim();
            const novoEmail = document.getElementById("userEmail").value.trim();
            const inputSenha = document.getElementById("inputSenha");
            const inputNova1 = document.getElementById("inputNovaSenha1");
            const inputNova2 = document.getElementById("inputNovaSenha2");

            const payload = {};
            if (novoNome !== usuario.nome) payload.nome = novoNome;
            if (novoEmail !== usuario.email) payload.email = novoEmail;

            // Troca de senha?
            if (inputSenha.value || inputNova1.value || inputNova2.value) {
                if (inputSenha.value !== usuario.senha) {
                    return alert("Senha atual incorreta.");
                }
                if (!inputNova1.value || inputNova1.value !== inputNova2.value) {
                    return alert("As novas senhas não conferem.");
                }
                if (inputNova1.value.length < 6) {
                    return alert("A nova senha deve ter no mínimo 6 caracteres.");
                }
                payload.senha = inputNova1.value;
            }

            if (Object.keys(payload).length === 0) {
                return alert("Nenhuma alteração a ser salva.");
            }

            fetch(`http://localhost:3000/usuarios/${usuario.id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(res => {
                    if (!res.ok) throw new Error(`Status ${res.status}`);
                    return res.json();
                })
                .then(usuarioAtualizado => {
                    sessionStorage.setItem("usuarioLogado", JSON.stringify(usuarioAtualizado));
                    window.usuario = usuarioAtualizado;

                    // limpa campos de senha
                    document.getElementById("inputSenha").value = "";
                    inputNova1.value = inputNova2.value = "";
                    inputNova1.disabled = inputNova2.disabled = true;

                    alert("Perfil atualizado com sucesso!");
                })
                .catch(err => {
                    console.error("Erro ao atualizar perfil:", err);
                    alert("Não foi possível salvar as mudanças. Tente novamente.");


                });
        });

        document.getElementById("btnCancel").addEventListener("click", () => {
            document.getElementById("userName").value = usuario.nome;
            document.getElementById("userEmail").value = usuario.email;
            const inputSenha = document.getElementById("inputSenha");
            const inputNova1 = document.getElementById("inputNovaSenha1");
            const inputNova2 = document.getElementById("inputNovaSenha2");
            [inputSenha, inputNova1, inputNova2].forEach(i => i.value = "");
            inputNova1.disabled = inputNova2.disabled = true;
        });

    </script>
</body>

</html>