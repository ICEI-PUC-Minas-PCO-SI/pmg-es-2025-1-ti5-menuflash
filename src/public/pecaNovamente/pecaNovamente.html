<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
    crossorigin="anonymous"></script>
  <title>Menu Flash</title>
</head>

<style>
  body {
    background-color: red;
  }

  body {
    background-color: #a00000;
  }

  .logo-container {
    flex: 1;
    justify-content: center;
  }

  .logo-img {
    max-height: 130px;
  }
</style>

<body>

  <header class="bg-white py-3 px-4 d-flex align-items-center">
    <div class="logo-container">
      <img src="assets/imgs/logoMenuFlash.png" alt="Logo Menu Flash" class="img-fluid logo-img">
    </div>

    <div class="fw-bold text-dark px-5">
      <a href="login.html" class="text-decoration-none text-dark me-2">Entrar</a> |
      <a href="cadastro.html" class="text-decoration-none text-dark ms-2">Cadastrar</a>
    </div>
  </header>

  <body>

    <!--NAVBAR-->

    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link text-dark" href="../principal/index.html">Alterar Campus</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-dark" href="#">Alterar Lanchonete</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-dark" href="../pecaNovamente/pecaNovamente.html">Peça Novamente</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-dark" href="">Histórico de pedidos</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!--CARDS-->

    <h1 class="mb-0 text-center text-light pb-0 pt-4">Peça Novamente</h1>
    <div id="pecaNovamente" class="container py-5 d-flex flex-column align-items-center mt-4">
      <!-- cards de peça novamente -->
    </div>

    <script>
      //alterar lanchonete na navbar
      ddocument.addEventListener('DOMContentLoaded', () => {
        const linkAlterarLanchonete = document.querySelector(".nav-link[href='#']");

        const campus = sessionStorage.getItem("campusAtual");
        const lanchoneteId = sessionStorage.getItem("lanchoneteAtualId");

        if (linkAlterarLanchonete && campus) {
          if (campus === "Coração Eucarístico") {
            linkAlterarLanchonete.href = `../campus/campusCoreu.html`;
          } else if (campus === "Contagem") {
            linkAlterarLanchonete.href = `../campus/campusContagem.html`;
          }
        }

        // Para voltar diretamente para os cards da lanchonete anterior:
        const btnVoltarLanchonete = document.createElement("button");
        btnVoltarLanchonete.className = "btn btn-warning mt-3";
        btnVoltarLanchonete.textContent = "Voltar";

        btnVoltarLanchonete.onclick = () => {
          if (lanchoneteId && campus) {
            window.location.href = `../criaCards.html?id=${lanchoneteId}&campus=${campus}`;
          }
        };

        const container = document.getElementById("pecaNovamente");
        if (container) {
          container.appendChild(btnVoltarLanchonete);
        }
      });

    </script>

    <script>

      document.addEventListener('DOMContentLoaded', () => {
        const cardPecaNovamente = document.getElementById("pecaNovamente");

        // Pega o usuário logado do sessionStorage
        const usuarioLogadoJSON = sessionStorage.getItem('usuarioLogado');
        if (!usuarioLogadoJSON) {
          alert("Você precisa estar logado para acessar esta página.");
          window.location.href = "../cadastro_login/login.html";
          return;
        }

        const usuario = JSON.parse(usuarioLogadoJSON);
        const usuario_id = usuario.usuario_id || usuario.id;

        fetch('http://localhost:3000/usuarios')
          .then(res => res.json())
          .then(json => {
            const usuarios = json.usuarios || json;

            const usuarioEncontrado = usuarios.find(u => u.usuario_id == usuario_id || u.id == usuario_id);
            if (!usuarioEncontrado) {
              alert("Usuário não encontrado.");
              return;
            }

            carregarPedidos(usuarioEncontrado);
          })
          .catch(error => {
            console.error("Erro ao buscar usuários:", error);
          });

        function carregarPedidos(usuario) {
          const pedidos = usuario.historico_de_pedidos || usuario.historico;

          if (!pedidos || pedidos.length === 0) {
            cardPecaNovamente.innerHTML = "<p class='text-white'>Você ainda não fez nenhum pedido.</p>";
            return;
          }

          pedidos.sort((a, b) => new Date(`${b.data}T${b.hora}`) - new Date(`${a.data}T${a.hora}`));
          const ultimoPedido = pedidos[0];

          cardPecaNovamente.innerHTML = "";

          ultimoPedido.itens.forEach(item => {
            let cardHTML = `
              <div class="card-header text-dark p-2 mt-3" style="background-color: #ffaf00;">
                ${usuario.nome} – Pedido #${ultimoPedido.pedido_id} – ${ultimoPedido.data} às ${ultimoPedido.hora}
              </div>
              <div class="m-0 p-1 mt-2 col-md-3 col-sm-6 col-xs-8 d-flex">
                <div class="card h-100 w-100 shadow-sm">     
                  <img src="${item.imagem}" class="card-img-top" alt="${item.nome}">
                  <div class="card-body text-center d-flex flex-column">
                    <h5 class="card-title">${item.nome}</h5>
                    <p>${item.quantidade} x R\$${item.preco_unitario.toFixed(2).replace('.', ',')}</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="fw-bold">R\$${item.subtotal.toFixed(2).replace('.', ',')}</span>
                      <button disabled type="button" class="btn btn-outline-secondary btn-sm">Adicionar ao carrinho</button>
                    </div>
                  </div>
                </div>
              </div>
            `;

            cardPecaNovamente.innerHTML += cardHTML;
          });
        }
      });

    </script>


  </body>

</html>